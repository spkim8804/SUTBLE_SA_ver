<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>SUBTLE behavior framework</title>
        
        <!-- CSS -->
        <link rel="canonical" href="https://getbootstrap.com/docs/5.1/examples/cover/">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link rel="stylesheet" href="css/cover.css">
        <link rel="stylesheet" href="css/subtle_style.css">
        <link rel="stylesheet" href="css/loader.css">

        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.143.0/build/three.module.js",
                    "orbitcontrol": "https://unpkg.com/three@0.143.0/examples/jsm/controls/OrbitControls.js"
                }
            }
        </script>
    </head>
    <body class="h-100 text-white bg-dark">
        <!-- Loading page -->
        <div class="loader" style="color: black;"></div>
        <div id="load_percentage" style="position: absolute; top: 50%; left: 50%;"></div>
        <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column container" style="display:none;">
            <!-- Top panel -->
            <header class="mb-auto">
                <div>
                    <h3 class="float-md-start mb-0"> <a style="text-decoration: none;" href="index.html">SUBTLE behavior framework</a></h3>          
                    <nav class="nav nav-masthead justify-content-center">
                        <a class="nav-link active" aria-current="page" href="index.html">Home</a>
                        <div class="nav-link active features_menu text-center">
                            <span>Features</span>
                            <ul class="nav-link active bg-dark features_menu_sub">
                                <li><a class="nav-link" href="demo.html">Demo</a></li>
                                <li><a class="nav-link" href="annotator.html">Annotator</a></li>
                                <li><a class="nav-link inactive" href="">Analysis</a></li>
                            </ul>
                        </div>
                        <a class="nav-link active" href="contact.html">Contact</a>
                    </nav>
                </div>
            </header>
        </div>
        <section id="directiory" class="bg-dark" style="font-size: 12px;">
            <button id="plot_visible" style="height: 25px; font-size: 14px">Plot</button>
            <input id="choose_directory" type="file" style="float:left" webkitdirectory>
        </section>

        <section id="skeleton_and_video" class="bg-dark">
            <div id="skeleton_section" class="bg-dark">
                <style>                    
                    #skeleton_section .skeleton_upload_box{
                        width: 35%;
                        float: left;
                        border:1px solid gray;
                        box-shadow: 2px 3px 9px hsl(0, 0%, 47%);
                        padding:10px;
                    }
                </style>
                <div class="skeleton_upload_box" id="canvas">
                    <div id="annotation_name" style="float: left; background-color: black; font-size: 16px;">idle</div>
                    <!-- <div id="annotation_file_name" style="position: absolute; font-size: 15px; top: 80px; left: 100px; background-color: black;">Demo annotation file</div> -->
                    <select id="filenames" style="float: right; font-size: 16px">
                        <option value="0">Demo annotation</option>
                    </select>
                </div>
            </div>
            
            <div id="video_section" class="bg-dark">
                <style>
                    #video_section .video_upload_box{
                        width: 40%;
                        float: left;
                        border:1px solid gray;
                        box-shadow: 2px 3px 9px hsl(0, 0%, 47%);
                        padding:10px;
                    }
                    .plot_style{
                        position: absolute;
                    }                    
                </style>
                <div class="video_upload_box">
                    <!-- <video id="video_player" src="https://raw.githubusercontent.com/spkim8804/subtle_demo/main/demo_video.mp4" type="video/mp4"></video> -->
                    <!-- <video id="video_player" src="static/files/ko_young_7701.mp4" type="video/mp4"></video> -->
                    <video id="video_player" src="files/ko_young_7701.mp4" type="video/mp4"></video>
                </div>
                <div id="umap_plot" style="display: none">
                    <svg id="tracePlot" class="plot_style" style="z-index: 2"></svg>
                    <svg id="scatterPlot" class="plot_style" style= "background-color: white; z-index: 1"></svg>
                    
                    <select id="plot_trace_cnt" style="z-index: 5; position: absolute;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="4">4</option>
                        <option value="10">10</option>
                    </select>
                </div>
            </div>
        </section>

        <section id="annotation_section" class="bg-dark" style="position: static">
            <style>
                #annotation_section .annotation_upload_box{
                    width: 60%;
                    float: left;
                    border:1px solid gray;
                    box-shadow: 2px 3px 9px hsl(0, 0%, 47%);
                    padding:10px;
                }
                .aligner{
                    display: flex;
                    flex-direction: column;
                }
            </style>
            <div class="annotation_upload_box aligner">
                <div>
                    <select id="annotation_select" style="float: left; font-size: 16px">
                        <option value="0">0</option>
                    </select>
                </div>
                <div>
                    <button id="click_all_btn" value="1" style="float: left; height: 25px; font-size: 14px">All</button>
                    <button id="click_none_btn" value="0" style="float: left; height: 25px; font-size: 14px">None</button>
                    <div class="Annot_select" id="Annot_select"></div>
                </div>
            </div>
        </section>
        
        <input id="video_input" type="file" accept="video/mp4">
        <input id="skeleton_input" type="file" accept="csv">
        <input id="annotation_input" type="file" accept="csv">
 
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/2.0.0-alpha.2/cropper.js"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
        <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.9/dat.gui.min.js"></script>
        <script type="text/javascript" sync src="https://unpkg.com/mediainfo.js/dist/umd/index.min.js"></script>
        <script src="js/dropdown.js"></script>
        <script src="js/loading.js"></script>
        <script src="https://d3js.org/d3.v6.min.js"></script>
        
        <script type="module">
            import * as THREE from 'three';
            import { OrbitControls } from 'orbitcontrol';
            
            function create2DArray(rows, columns) {
                var arr = new Array(rows);
                for (var i = 0; i < rows; i++) {
                    arr[i] = new Array(columns);
                }
                return arr;
            }
            
            // Loading page transitions after page loading
            $(document).ready(function(){
                _showPage();
            })

            // Demo csv file upload
            $.ajax({
                type: "GET",
                // url: "https://github.com/spkim8804/SUTBLE_SA_ver/blob/master/files/ko_young_7701.csv",
                url: "files/ko_young_7701.csv",
                dataType: "text",
                sync: true,
                success: function(file) {
                    console.log("csv file is uploaded!")
                    read_merged_files(file, "Demo annotation", 0);
                    streaming();
                },
                error: function(xhr, status, error) {
                    console.error("An error occurred: " + error);
                }
            });

            document.getElementById("click_all_btn").addEventListener("click", function(e){ click_annot(e.target.value); });
            document.getElementById("click_none_btn").addEventListener("click", function(e){ click_annot(e.target.value); });
            document.querySelector('.Annot_select').addEventListener("click", function(e){ chkbox(e.target);})
            document.getElementById("filenames").addEventListener("change", function(e){
                // Use same chkbox status
                annot_status[e.target.value] = annot_status[current_file_num];
                
                current_file_num = e.target.value;
                if(plot_enable == 1) refresh_plot();
                for (var i = 0; i < video_cnt; i++){
                    if(current_file_name[current_file_num] == video_names[i]){
                        video.setAttribute("src", video_files[i]);
                        video.load();
                        current_fps = video_fps[i];
                        break;
                    }
                }
                if(i == video_cnt){
                    console.log("No matched video has been found!");
                }
            });
            
            var CANVAS_WIDTH = 800;
            var CANVAS_HEIGHT = 600;

            var current_fps = 20;
            var video_fps = [];

            var merged_file = [];
          
            var annot_status = [];
            var annot_status2 = [];

            var current_file_num = 0;
            var current_file_name = [];
            var current_annot_num = 0;
            var annotation_select = document.getElementById("annotation_select");
            var total_csv_file = 1;
            
            // D3.js variables
            var model_x_max = [];
            var model_x_min = [];
            var model_y_max = [];
            var model_y_min = [];
            var plot_x = [];
            var plot_y = [];
            var plot_colors = ["red","blue","orange","green","purple","skyblue"];
            var plot_data = [];
            var plot_enable = 0;

            var annot2 = new Array();
            
            var skeleton_total_frame = [];        
            var video_files = [];
            var video_names = [];
            var video_cnt = 0;

            var plot_image;
            var plot_human = [];
            var plot_super = [];
            // plot_image = "https://raw.githubusercontent.com/spkim8804/subtle_demo/main/annotation_human.png";
            var plot_number = 1;
            var plot_trace = document.getElementById('plot_trace_cnt');
            plot_trace.style = "position: absolute; top: "+(80+window.innerWidth*21/100)+"px; left: +"+(window.innerWidth*59/100)+"px; z-index: 3";
            plot_trace.addEventListener("change", function(e){
                plot_number = parseInt(plot_trace.options[plot_trace.selectedIndex].value);
            });
            var plot_visible = document.getElementById("plot_visible");
            var umap_plot = document.getElementById("umap_plot");
            plot_visible.addEventListener("click", function(e){
                if(plot_enable == 0){
                    refresh_plot();
                    umap_plot.style = "display: block";
                    plot_enable = 1;
                } else if(plot_enable == 1){
                    umap_plot.style = "display: none";
                    plot_enable = 0;
                }
            });

            var control = new function(){

                this.Fps = 20;
                this.Frameskip = 1;

                this.Time = 0;

                this.Trace = 1;

                this.AutoRotation = false;
                this.TimeDimension = false;

                this.Object = 0;

                this.Head = true;
                this.Neck = true;
                this.Spine = true;
                this.Tail = true;
                this.Hindlimb = true;
                this.Forelimb = true;

                this.Vision =false;

                this.DarkSkin = false;
                this.Playstatus = true;
                this.limbs = true;
            }

            var gui = new dat.GUI();
            gui.width = '180';
            gui.add( control, 'Fps' , 1 , 60).listen();
            // gui.add( control, 'Trace' , 1, 50).listen(); 
            gui.add( control, 'Frameskip' , 1 , 20 ).listen();
            gui.add( control, 'AutoRotation', true).listen();
            gui.add( control, 'Playstatus', true).listen();
            gui.add( control, 'DarkSkin', false).listen();
            gui.add( control, 'limbs', true).listen();
            gui.add( control, 'Time' , 0, skeleton_total_frame[0]).listen();

            const load_percentage = document.getElementById("load_percentage");

            const annotation_name = document.getElementById('annotation_name');
            // const video_file_name = document.getElementById('video_file_name');
            const annotation_file_name = document.getElementById('annotation_file_name');
            
            // var video_section = document.querySelector('#video_section');
            // var video_upload_box = video_section.querySelector('.video_upload_box');
            // const video = document.getElementById('video_player');

            // Video file input
            var video_section = document.querySelector('#video_section');
            var video_upload_box = video_section.querySelector('.video_upload_box');
            const video = document.getElementById('video_player');
            const dnd_video = document.getElementById('video_input');
            dnd_video.addEventListener("change", function(){ video_load(dnd_video.files[0]); });
            function open_video_file(){ dnd_video.click();} // Open video file button
            //'#343a40'
            video_upload_box.addEventListener('dragenter', function(e) { this.style.backgroundColor = 'white'; });
            video_upload_box.addEventListener('dragleave', function(e) { this.style.backgroundColor = '#232222'; });
            video_upload_box.addEventListener('dragover', function(e) { e.preventDefault(); this.style.backgroundColor = 'white';});
            video_upload_box.addEventListener('drop', function(e) {
                e.preventDefault();
                video_load(e.dataTransfer.files[0]);
                this.style.backgroundColor = '#232222';
            });
            
            // Demo video file upload
            var xhr = new XMLHttpRequest();
            xhr.open('GET', 'files/ko_young_7701.mp4', true);
            xhr.responseType = 'blob';

            xhr.onload = function () {
                if (this.status === 200) {
                    var videoBlob = this.response;
                    var vid = URL.createObjectURL(videoBlob); // IE10+
                    // Video is now downloaded and can be played
                    var videoPlayer = document.getElementById('video_player');
                    videoPlayer.src = vid;
                    console.log("video file is uploaded!");
                }
            };

            xhr.onerror = function () {
            console.error("Error while fetching video");
            };
            xhr.send();
            ///////////////////////////////////////////////

            function video_load(file){
                if(file['type']=='video/mp4'){
                    const videourl = URL.createObjectURL(file);
                    video_names[video_cnt] = videourl;
                    video.setAttribute("src", videourl);
                    // video_file_name.innerHTML = file.name;
                    video.load();
                    // control.Time = 0;
                    videoinfo(file); // get fps and total frames
                } else{
                    alert("Please upload mp4 file!");
                }
            }            

            // Assure file loading 
            function readFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const fileContent = reader.result;
                        resolve(fileContent);
                    };
                    reader.onerror = () => {
                        reject(new Error("Failed to read the file."));
                    };
                    reader.readAsText(file);
                });
            }

            // Choose directory (local)
            const choose_directory = document.getElementById('choose_directory');
            choose_directory.addEventListener('change', async function(e){
                
                if(e.target.files.length > 0){
                    _loadPage();
                    control.Playstatus = false;
                    
                    const file = e.target.files;
                    var temp = [];
                    var name = [];
                    current_file_name = [];
                    for(var i = 0; i < file.length; i++){
                        if(file[i].name.split(".")[file[i].name.split(".").length-1] == "csv"){
                            const fileContent = await readFile(file[i]);
                            const temp_name = e.target.files[i].name;
                            name.push(e.target.files[i].name);
                            temp.push(fileContent);
                            current_file_name.push(e.target.files[i].name.split(".")[0]);
                        } else if(file[i].name.split(".")[file[i].name.split(".").length-1] == "mp4"){
                            const videourl = URL.createObjectURL(file[i]);
                            video_files[video_cnt] = videourl;
                            video_names[video_cnt] = file[i].name.split(".")[0];
                            videoinfo(file[i], video_cnt);
                            video_cnt += 1;
                        }
                    }
                    read_merged_files(temp, name, 1);
                    // console.log(video_fps);
                    // _showPage();
                }
            });
            annotation_select.addEventListener('change', function(e){
                current_annot_num = parseInt(e.target.value);
                set_annot_categories(annot_status2[current_file_num][current_annot_num].length);
            });
            
            function load_merged_file(temp, n, column){
                var array = create2DArray((temp.length-1)/column + 1, column);
                var k = 0;
                
                // Get total frames
                skeleton_total_frame[n] = 0;
                
                outer: for (var i = 0; i <= temp.length; i=i+1){                    
                    for (var j = 0; j < column; j=j+1) {
                        array[i][j] = 0;
                        array[i][j] = temp[k];k++;
                        array[i][j] = array[i][j].split("\r")[0]; // prevent \r
                        if (k>=((temp.length)-1)) break outer;
                    }
                    skeleton_total_frame[n]+=1;
                }
                skeleton_total_frame[n]+=1;
                
                var temp_name = [];
                var temp_type = [];
                var temp_status = [];
                for (var i = 30; i < column; i++){
                    var temp_annot2d = [];
                    var temp_cnt = 0;
                    var temp_annot_status = [];
                    for (var j = 1; j < skeleton_total_frame[n]; j++){
                        for (var k = 0; k < temp_annot2d.length; k++){
                            if(array[j][i] == temp_annot2d[k]) break;
                        }
                        if(k == temp_annot2d.length){                            
                            temp_annot2d[temp_cnt] = array[j][i];
                            temp_annot_status[array[j][i]] = false;
                            temp_cnt += 1;
                        }
                    }
                    temp_type[i-30] = temp_annot2d;
                    temp_status[i-30] = temp_annot_status;
                    temp_name[i-30] = array[0][i];
                }
                annot_status[n] = temp_status;
                annot_status2[n] = temp_type;
                annot_status2[n].name = temp_name;

                // annotation sorting
                for (var i = 0; i < annot_status2[n].length; i++){
                    for (var j = 0; j < annot_status2[n][i].length; j++){
                        for (var k = j+1; k < annot_status2[n][i].length; k++){
                            if(annot_status2[n][i][j]>annot_status2[n][i][k]){
                                var sort = annot_status2[n][i][j];
                                annot_status2[n][i][j] = annot_status2[n][i][k];
                                annot_status2[n][i][k] = sort;
                            }
                        }
                    }
                    annot_status[n][i][annot_status2[n][i][0]] = true;
                }
                merged_file[n] = array;
                
                // Set the axis of plot
                var x_axis = Array(skeleton_total_frame[n])
                var y_axis = Array(skeleton_total_frame[n])
                model_x_max[n] = parseFloat(array[1][28]);
                model_x_min[n] = parseFloat(array[1][28]);
                model_y_max[n] = parseFloat(array[1][29]);
                model_y_min[n] = parseFloat(array[1][29]);
                for (var i = 1; i <= skeleton_total_frame[n]; i=i+1){
                    if(parseFloat(array[i][28])>model_x_max[n]) model_x_max[n]=parseFloat(array[i][28]);
                    if(parseFloat(array[i][28])<model_x_min[n]) model_x_min[n]=parseFloat(array[i][28]);
                    if(parseFloat(array[i][29])>model_y_max[n]) model_y_max[n]=parseFloat(array[i][29]);
                    if(parseFloat(array[i][29])<model_y_min[n]) model_y_min[n]=parseFloat(array[i][29]);
                    x_axis[i-1]=array[i][28];
                    y_axis[i-1]=array[i][29];
                }
                plot_x[n] = x_axis;
                plot_y[n] = y_axis;

                // Human plot
                var color_for_super = [];
                for (var i = 0; i < skeleton_total_frame[n]; i++){
                    if(i!=0) color_for_super[i-1]=array[i][31];
                }
                
                plot_data[n] = plot_x[n].map((value, index) => ({
                    x: value,
                    y: plot_y[n][index],
                    color: color_for_super[index],
                }));
            }
            function refresh_annotation_select(){
                while (annotation_select.firstChild) {
                    annotation_select.removeChild(annotation_select.firstChild);
                }
                for(var i=0; i<annot_status2[current_file_num].name.length; i++){
                    const new_opt = document.createElement("option");
                    new_opt.setAttribute("value", i);
                    new_opt.innerHTML = annot_status2[current_file_num].name[i];
                    annotation_select.appendChild(new_opt);
                }
            }
            function read_merged_files(e, name, filter) {
                if(e.length>200 && filter == 1){
                    alert("Too much files! Please reduce samples less than 200");
                } else{
                    var cnt_temp = 0;
                    if(filter == 0){
                        cnt_temp = 1;
                    } else if(filter == 1){
                        for (var i = 0; i < e.length; i++){
                            if(name[i].split(".")[name[i].split(".").length-1]=="csv") cnt_temp += 1;
                        }
                    }
                    total_csv_file = cnt_temp;
                    if(cnt_temp == 0){
                        alert("There is no csv file in this directory!");
                    } else{
                        const new_filenames = document.getElementById('filenames');

                        cnt_temp = 0;
                        var i = 0;
                        task();
                        function task(){
                            if(filter==0){ var input = e;
                            } else{ var input=e[i];}
                            var temp = input.split('\n');
                            var temp2 = temp[0].split(',');
                            if(temp2[0]=='avatar_subtle'){                          
                                load_percentage.innerHTML = "Loading<br>0 %";
                                load_percentage.style = "position: absolute; left: "+window.innerWidth*46/100+"px; top: "+window.innerHeight*45/100+"px; display: block"; 
                                
                                load_merged_file(input.split(/,|\n/), cnt_temp, temp2.length);
                                // Loaded files
                                if(filter == 1){
                                    if(cnt_temp==0){
                                        // Remove previous files
                                        while (new_filenames.firstChild) {
                                            new_filenames.removeChild(new_filenames.firstChild);
                                        }
                                    }
                                    const new_opt = document.createElement("option");
                                    new_opt.setAttribute("value", cnt_temp);
                                    new_opt.innerHTML = name[i].split(".")[0];
                                    new_filenames.appendChild(new_opt);
                                }
                                cnt_temp += 1;
                            }
                            i+=1;
                            load_percentage.innerHTML = "Loading<br>" + String(parseInt(i/e.length*100)) + " %";
                            // Loading complete
                            if(i==e.length || filter == 0){
                                control.Playstatus = true;
                                load_percentage.style = "position: absolute; left: "+window.innerWidth*46/100+"px; top: "+window.innerHeight*45/100+"px; display: none";
                                _showPage();
                                return;
                            }
                            setTimeout(task, 0);
                        }
                        if(cnt_temp ==0){
                            alert("No avatar_subtle file was found!");
                        } else{
                            refresh_annotation_select();
                            set_annot_categories(annot_status2[current_file_num][current_annot_num].length);
                            gui.__controllers[6].remove();
                            gui.add(control, 'Time' , 0, skeleton_total_frame[current_file_num]).listen();
                            if(plot_enable == 1) refresh_plot();
                        }
                    }
                }
            }
            
            // Resize plot
            function refresh_plot(){
                // Adjust the size
                const plot_style = document.querySelectorAll(".plot_style");
                plot_style.forEach((e) => {
                    e.style.width = window.innerWidth*25/100 + "px";
                    e.style.height = window.innerWidth*25/100 + "px";
                    e.style.top = (75+window.innerWidth*21/100)+"px";
                    e.style.left = "59%";
                });
                
                // Main plot
                const scatterPlot = document.getElementById('scatterPlot');
                
                const svg = d3.select("#scatterPlot");
                const xScale = d3.scaleLinear().domain([model_x_min[current_file_num], model_x_max[current_file_num]]).range([0, window.innerWidth/4]);
                const yScale = d3.scaleLinear().domain([model_y_min[current_file_num], model_y_max[current_file_num]]).range([window.innerWidth/4, 0]);
                
                svg.selectAll("circle").remove(); // Remove existing plot
                
                svg
                    .selectAll("circle")
                    .data(plot_data[current_file_num])
                    .enter()
                    .append("circle")
                    .attr("cx", (d) => xScale(d.x))
                    .attr("cy", (d) => yScale(d.y))
                    .attr("r", 0.5)
                    .style("fill", (d) => plot_colors[d.color])
                    // .style("opacity", 0.3);
                
                // Trace number re-position
                plot_trace.style = "position: absolute; top: "+(80+window.innerWidth*21/100)+"px; left: +"+(window.innerWidth*59/100)+"px; z-index: 3";
            }
            // Resize window
            function onWindowResize(){
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth*28/100, window.innerWidth*28/100);
                
                if(plot_enable == 1) refresh_plot(); // Resize plot
            }
            
            // Main program ------------------------------------------
            var slist=0;
            
            // camera
            var camera = new THREE.PerspectiveCamera(25, CANVAS_WIDTH / CANVAS_HEIGHT, 0.1, 100)
            camera.position.z = 20;
            camera.position.y = 30;
            camera.position.x = 30;

            //renderer
            var renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth*28/100, window.innerWidth*28/100);
            document.getElementById('canvas').appendChild(renderer.domElement);
            window.addEventListener('resize', onWindowResize, false);

            //scene
            var scene = new THREE.Scene();

            camera.up.set( 0, 0, 1 );

            function box(){

                var points3Dx = new THREE.BufferGeometry();
                var points3Dy = new THREE.BufferGeometry();

                var x = 9;
                var z1 = -0.7;
                var z2 = -0.71;
                
                var size = 9,
                    steps = 2;

                var points = [];
                material = new THREE.LineBasicMaterial({color:  0x303030});

                for (var i = -size; i <= size; i += steps) {
                    points.push(new THREE.Vector3(-size, i,z1));
                    points.push(new THREE.Vector3(size, i,z1));
                    points.push(new THREE.Vector3(i,  -size,z1));
                    points.push(new THREE.Vector3(i, size, z1));
                }
                geometry = new THREE.BufferGeometry().setFromPoints(points);

                //THREE.LinePieces prevents connecting of vertices
                var line = new THREE.LineSegments(geometry, material, THREE.LinePieces);

                scene.add(line);
                slist +=1;

                let geometry2 = new THREE.BufferGeometry();
                const points2 = [
                        new THREE.Vector3(-x, -x,  z2),  // 0
                        new THREE.Vector3( x,  x,  z2),  // 3
                        new THREE.Vector3(-x,  x,  z2),  // 2

                        new THREE.Vector3(-x, -x,  z2),  // 0
                        new THREE.Vector3( x, -x,  z2),  // 1
                        new THREE.Vector3( x,  x,  z2),  // 3
                ];
                geometry2.setFromPoints(points2);
            
                const material2 = new THREE.MeshBasicMaterial({color:0x101015});

                const cube = new THREE.Mesh(geometry2, material2);

                cube.material.opacity = 0;
                cube.material.transparent = true;
                scene.add(cube); 
                slist +=1;
            }

            function octa(x1, y1, z1, x2, y2, z2, line){

                if (z1<-0.7)
                    z1=-0.7;
                if (z2<-0.7)
                    z2=-0.7;

                var dis = Math.sqrt( Math.pow(x2-x1,2)+Math.pow(y2-y1,2)+Math.pow(z2-z1,2) )/2;

                line.position.x=0;
                line.position.y=0;
                line.position.z=0;
                line.position.set(0, 0, 0);
                line.rotation.set(0, 0, 0);

                line.scale.set(dis,1,1);

                var dx=(Number(x1) + Number(x2)) /2;
                var dy=(Number(y1) + Number(y2)) /2;
                var dz=(Number(z1) + Number(z2)) /2;
                line.translateX(dx);
                line.translateY(dy);
                line.translateZ(dz);
                var ay = Math.atan2(z2-z1, x2-x1); 
                var az = Math.atan2(y2-y1, Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(z1 - z2, 2))); 
                line.rotation.y =-ay// 10*3.14/180;
                line.rotation.z =az// 10*3.14/180;
            }

            function line(x1, y1, z1, x2, y2, z2, line){

            }

            function vision(x1, y1, z1, x2, y2, z2,line,color){

                var geometry = new THREE.ConeGeometry( 1, 4, 8 );//radius : Float, height : Float, radialSegments : Integer,
                var material = new THREE.MeshBasicMaterial( { transparent: true, opacity: 0.05, color: 0xFFFF00} );
                var cone = new THREE.Mesh( geometry, material );
                cone.material.opacity = color/10;
                scene.add( cone );

                if (z1<-0.7)
                z1=-0.7;
                if (z2<-0.7)
                z2=-0.7;

                var dis = Math.sqrt( Math.pow(x2-x1,2)+Math.pow(y2-y1,2)+Math.pow(z2-z1,2)  )/2;

                cone.position.x=0;
                cone.position.y=0;
                cone.position.z=0;
                cone.position.set( 0, 0, 0 );
                cone.rotation.set(0, 0, 0);

                var dx=Number((x1-x2+dis*x1)/dis); 
                var dy=Number((y1-y2+dis*y1)/dis);
                var dz=Number((z1-z2+dis*z1)/dis);
                    cone.translateX(dx );
                    cone.translateY(dy );
                    cone.translateZ( dz );
                var ay = Math.atan2(z2-z1,x2-x1); 
                var az = Math.atan2(y2-y1, Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(z1 - z2, 2))); 

                cone.rotation.y =-ay+control.x// 10*3.14/180;s
                cone.rotation.z =-(3.14/2)+az+control.y// 10*3.14/180;
            }
            var hist;
            var timelog=-1;

            var controls = new OrbitControls (camera, renderer.domElement);
            controls.rotateSpeed = 1; 
            controls.zoomSpeed = 1.5; 
            controls.panSpeed = 0.5; 
            controls.minDistance = 5; 
            controls.maxDistance = 1000; 

            var points = [];
            var a=0.2;
            var b=1;
            points.push(
                new THREE.Vector3(b,0, 0),  new THREE.Vector3(0,a, a),  new THREE.Vector3(b,0, 0),  new THREE.Vector3(0,a, -a),
                new THREE.Vector3(b,0, 0),  new THREE.Vector3(0,-a,-a),  new THREE.Vector3(b,0, 0),  new THREE.Vector3(0,-a,a),
                new THREE.Vector3(0,a, a),  new THREE.Vector3(0,a, -a),  new THREE.Vector3(0,-a,-a),  new THREE.Vector3(0,-a,a),
                new THREE.Vector3(-b,0, 0),  new THREE.Vector3(0,a, a),  new THREE.Vector3(-b,0, 0),  new THREE.Vector3(0,a,-a),
                new THREE.Vector3(-b,0, 0),  new THREE.Vector3(0,-a,-a),  new THREE.Vector3(-b,0, 0),
            );
            let points3D = new THREE.BufferGeometry().setFromPoints(points);
            
            let geometry2 = new THREE.BufferGeometry();
            var points2 = [
                new THREE.Vector3(b,0, 0),//0
                new THREE.Vector3(0,-a,a),//1
                new THREE.Vector3(0,a, a),//2
                
                new THREE.Vector3(b,0, 0),//0
                new THREE.Vector3(0,a, a),//2
                new THREE.Vector3(0,a, -a),//3

                new THREE.Vector3(b,0, 0),//0
                new THREE.Vector3(0,a, -a),//3
                new THREE.Vector3(0,-a,-a),//4

                new THREE.Vector3(b,0, 0),//0
                new THREE.Vector3(0,-a,-a),//4
                new THREE.Vector3(0,-a,a),//1

                new THREE.Vector3(-b,0, 0),//5
                new THREE.Vector3(0,-a,a),//1
                new THREE.Vector3(0,a, a),//2

                new THREE.Vector3(-b,0, 0),//5
                new THREE.Vector3(0,a, a),//2
                new THREE.Vector3(0,a, -a),//3
                
                new THREE.Vector3(-b,0, 0),//5
                new THREE.Vector3(0,a, -a),//3
                new THREE.Vector3(0,-a,-a),//4

                new THREE.Vector3(-b,0, 0),//5
                new THREE.Vector3(0,-a,-a),//4
                new THREE.Vector3(0,-a,a),//1
            ];
            geometry2.setFromPoints(points2);
            
            const material2 = new THREE.MeshBasicMaterial({color:0xffffff});

            var line1 = new THREE.Mesh(geometry2, material2);

            box();

            var geometry = new THREE.CylinderGeometry( 0.2, 0.2, 10, 32 );
            var material = new THREE.MeshBasicMaterial( {color: 0x999999} );
            var cy = new THREE.Mesh( geometry, material );

            cy.position.set(-3,-4.1,9.4);
            cy.rotation.set(3.14/2, 0, 0);

            var cy2 = new THREE.Mesh( geometry, material );

            cy2.position.set(1.5,-4.1,9.4);
            cy2.rotation.set(3.14/2, 0, 0);

            var geometry = new THREE.CylinderGeometry( 0.2, 0.2, 1, 32 );
            var material = new THREE.MeshBasicMaterial( {color: 0x999999} );
            var cy1 = new THREE.Mesh( geometry, material );

            cy1.position.set(-3,-3.8,4.2);
            cy1.rotation.set(3.14/1.3, 0, 0);
            var cy3 = new THREE.Mesh( geometry, material );

            cy3.position.set(1.5,-3.8,4.2);
            cy3.rotation.set(3.14/1.3, 0,0 );

            function poseseq(array,color){
                if (control.Head == true){
                var line1s = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c1, transparent: true, opacity: 1}) );
                scene.add(line1s); slist +=1;line1s.material.opacity = color;
                octa(array[1], array[2], array[3],array[4], array[5], array[6],   line1s)
                }
                if (control.Neck == true){
                var line2s = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c2, transparent: true, opacity: 1}) );
                scene.add(line2s); slist +=1;line2s.material.opacity = color;
                octa(array[10], array[11], array[12],array[4], array[5], array[6],line2s)}
                if (control.Spine == true){
                var line3s = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c3, transparent: true, opacity: 1}) );
                scene.add(line3s); slist +=1;line3s.material.opacity = color;
                octa(array[10], array[11], array[12],array[7], array[8], array[9],line3s)}
                if (control.Tail == true){
                var line4s = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c4, transparent: true, opacity: 1}) );
                scene.add(line4s); slist +=1;line4s.material.opacity = color;
                octa(array[25], array[26], array[27],array[7], array[8], array[9],line4s)}
                if (control.Hindlimb == true){
                var line5s = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c7, transparent: true, opacity: 1}) );
                scene.add(line5s); slist +=1;line5s.material.opacity = color;
                octa(array[7], array[8], array[9],array[13], array[14], array[15],line5s)}
                if (control.Hindlimb == true){
                var line6s = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c8, transparent: true, opacity: 1}) );
                scene.add(line6s); slist +=1;line6s.material.opacity = color;
                octa(array[7], array[8], array[9],array[16], array[17], array[18],line6s)}
                if (control.Forelimb == true){
                var line7s = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c5, transparent: true, opacity: 1}) );
                scene.add(line7s); slist +=1;line7s.material.opacity = color;
                octa(array[10], array[11], array[12],array[19], array[20], array[21],line7s)}
                if (control.Forelimb == true){
                var line8s = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c6, transparent: true, opacity: 1}) );
                scene.add(line8s); slist +=1;line8s.material.opacity = color;
                octa(array[10], array[11], array[12],array[22], array[23], array[24],line8s)}

                if (control.Vision ==true){
                    vision(array[1], array[2], array[3],array[4], array[5], array[6],line1s,color)
                }
            }

            function pose(array,color){
                if(control.limbs == true){
                    const lineGeometry1 = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(array[1], array[2], array[3]),
                        new THREE.Vector3(array[4], array[5], array[6])
                    ]);
                    const lineGeometry2 = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(array[10], array[11], array[12]),
                        new THREE.Vector3(array[4], array[5], array[6])
                    ]);
                    const lineGeometry3 = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(array[10], array[11], array[12]),
                        new THREE.Vector3(array[7], array[8], array[9])
                    ]);
                    const lineGeometry4 = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(array[25], array[26], array[27]),
                        new THREE.Vector3(array[7], array[8], array[9])
                    ]);
                    const lineGeometry5 = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(array[7], array[8], array[9]),
                        new THREE.Vector3(array[13], array[14], array[15])
                    ]);
                    const lineGeometry6 = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(array[7], array[8], array[9]),
                        new THREE.Vector3(array[16], array[17], array[18])
                    ]);
                    const lineGeometry7 = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(array[10], array[11], array[12]),
                        new THREE.Vector3(array[19], array[20], array[21])
                    ]);
                    const lineGeometry8 = new THREE.BufferGeometry().setFromPoints([
                        new THREE.Vector3(array[10], array[11], array[12]),
                        new THREE.Vector3(array[22], array[23], array[24])
                    ]);
                    var line1 = new THREE.Line( lineGeometry1, new THREE.LineBasicMaterial({color:c1, transparent: true, opacity: color}) );
                    var line2 = new THREE.Line( lineGeometry2, new THREE.LineBasicMaterial({color:c2, transparent: true, opacity: color}) );
                    var line3 = new THREE.Line( lineGeometry3, new THREE.LineBasicMaterial({color:c3, transparent: true, opacity: color}) );
                    var line4 = new THREE.Line( lineGeometry4, new THREE.LineBasicMaterial({color:c4, transparent: true, opacity: color}) );
                    var line5 = new THREE.Line( lineGeometry5, new THREE.LineBasicMaterial({color:c5, transparent: true, opacity: color}) );
                    var line6 = new THREE.Line( lineGeometry6, new THREE.LineBasicMaterial({color:c6, transparent: true, opacity: color}) );
                    var line7 = new THREE.Line( lineGeometry7, new THREE.LineBasicMaterial({color:c7, transparent: true, opacity: color}) );
                    var line8 = new THREE.Line( lineGeometry8, new THREE.LineBasicMaterial({color:c8, transparent: true, opacity: color}) );

                    const limb_coordinates = [
                        new THREE.Vector3(array[13], array[14], array[15]),
                        new THREE.Vector3(array[16], array[17], array[18]),
                        new THREE.Vector3(array[19], array[20], array[21]),
                        new THREE.Vector3(array[22], array[23], array[24])
                    ];
                    const dotGeometry = new THREE.SphereGeometry(0.2, 16, 16); // Parameters: radius, widthSegments, heightSegments
                    const dotMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
                    limb_coordinates.forEach((coordinate) => {
                        const dot = new THREE.Mesh(dotGeometry, dotMaterial);
                        dot.position.copy(coordinate);
                        scene.add(dot);
                    });
                } else{
                    var line1 = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c1, transparent: true, opacity: color}) );
                    var line2 = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c2, transparent: true, opacity: color}) );
                    var line3 = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c3, transparent: true, opacity: color}) );
                    var line4 = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c4, transparent: true, opacity: color}) );
                    var line5 = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c5, transparent: true, opacity: color}) );
                    var line6 = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c6, transparent: true, opacity: color}) );
                    var line7 = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c7, transparent: true, opacity: color}) );
                    var line8 = new THREE.Line( points3D, new THREE.LineBasicMaterial({color:c8, transparent: true, opacity: color}) );

                    octa(array[1], array[2], array[3],array[4], array[5], array[6], line1)
                    octa(array[10], array[11], array[12],array[4], array[5], array[6], line2)
                    octa(array[10], array[11], array[12],array[7], array[8], array[9], line3)
                    octa(array[25], array[26], array[27],array[7], array[8], array[9], line4)

                    octa(array[7], array[8], array[9],array[13], array[14], array[15], line5)
                    octa(array[7], array[8], array[9],array[16], array[17], array[18], line6)
                            
                    octa(array[10], array[11], array[12],array[19], array[20], array[21], line7)      
                    octa(array[10], array[11], array[12],array[22], array[23], array[24], line8)
                }               

                if (control.Head == true)
                hist = line1.clone();scene.add(hist); slist +=1;
                if (control.Neck == true)
                hist = line2.clone();scene.add(hist); slist +=1;
                if (control.Spine == true)
                hist = line3.clone();scene.add(hist); slist +=1;
                if (control.Tail == true)
                hist = line4.clone();scene.add(hist); slist +=1;
                if (control.Hindlimb == true)
                hist = line5.clone();scene.add(hist); slist +=1;
                if (control.Hindlimb == true)
                hist = line6.clone();scene.add(hist); slist +=1;
                if (control.Forelimb == true)
                hist = line7.clone();scene.add(hist); slist +=1;
                if (control.Forelimb == true)
                hist = line8.clone();scene.add(hist); slist +=1;
            }

            // var colors = [
            //     "rgb(255, 0, 0)",
            //     "rgb(255, 69, 0)",
            //     "rgb(255, 255, 0)",
            //     "rgb(0, 255, 0)",
            //     "rgb(0, 100, 255)",
            //     "rgb(50, 0, 255)",
            //     "rgb(175, 0, 255)",
            //     "rgb(255, 0, 255)",
            //     "rgb(100, 100, 100)",
            //     "rgb(255, 255, 255)"
            // ]
            var colors = Array(8).fill("rgb(0, 0, 0)");
            var rot=0;

            // Original color codes
            var c1="#C12026";
            var c2="#E54D26";
            var c3="#F78E23";
            var c4="#FEC015";
            var c5="#61AE44";
            var c6="#0D8DB0";
            var c7="#D125A0";
            var c8="#6D256E";
            
            function end_of_video(){
                control.Time = 0;
                // Use same chkbox status
                annot_status[parseInt(current_file_num) + 1] = annot_status[current_file_num];

                current_file_num = parseInt(current_file_num) + 1;
                if(current_file_num >= total_csv_file) current_file_num -= 1;
                // console.log(current_file_num);
                const new_filenames = document.getElementById('filenames');
                new_filenames.value = current_file_num;
                for (var i = 0; i < video_cnt; i++){
                    if(current_file_name[current_file_num] == video_names[i]){
                        video.setAttribute("src", video_files[i]);
                        video.load();
                        current_fps = video_fps[i];
                        break;
                    }
                }
            }

            function render() {
                // Visualize filtered frames only
                while(true){
                    var temp = false;
                    if(parseInt(control.Time)<0) parseInt(control.Time) = 0;
                    if(control.Time>=skeleton_total_frame[current_file_num]) end_of_video();
                    for(var i = 0; i < annot_status2[current_file_num][current_annot_num].length; i+=1){
                        if(annot_status[current_file_num][current_annot_num][annot_status2[current_file_num][current_annot_num][i]]==true && 
                            merged_file[current_file_num][parseInt(control.Time)][30+current_annot_num]==annot_status2[current_file_num][current_annot_num][i]
                            // && parseFloat(merged_file[current_file_num][parseInt(control.Time)][36])<0 //LF-RF, negative 
                            // && parseFloat(merged_file[current_file_num][parseInt(control.Time)][36])>0 // LF-RF, positive
                            // && parseFloat(merged_file[current_file_num][parseInt(control.Time)][37])>0 // LH-RH, positive
                            // && parseFloat(merged_file[current_file_num][parseInt(control.Time)][37])<0 // LH-RH, negative
                            ){
                            temp = true;
                            break;
                        }
                    } 
                    if(temp==true) break;
                    
                    control.Time += parseInt(control.Frameskip);
                    if(control.Time>=skeleton_total_frame[current_file_num]) end_of_video();
                }
                // console.log(parseFloat(merged_file[current_file_num][parseInt(control.Time)][36]));
                if (control.DarkSkin == false){
                    c1="#000000"; // head
                    c2="#000000"; // neck
                    c3="#000000"; // body
                    c4="#000000"; // tail
                    c5="#0099ff"; // r-arm
                    c6="#0099ff"; // l-arm
                    c7="#00ff00"; // r-leg
                    c8="#00ff00"; // l-leg
                    scene.background = new THREE.Color( 0xf0f0f0 );
                } else if (control.DarkSkin == true){
                    // c1="#ffffff";
                    // c2="#00ffff";
                    // c3="#0000ff";
                    // c4="#ff00ff";
                    // c5="#ff0000";
                    // c6="#ff0099";
                    // c7="#00ff00";
                    // c8="#99ff99";
                    c1="#ffffff"; // head
                    c2="#ffffff"; // neck
                    c3="#ffffff"; // body
                    c4="#ffffff"; // tail
                    c5="#0099ff"; // r-arm
                    c6="#0099ff"; // l-arm
                    c7="#00ff00"; // r-leg
                    c8="#00ff00"; // l-leg
                    scene.background = new THREE.Color( 0x000000 ); 
                }                        
                
                renderer.renderLists.dispose();

                controls.update();
                renderer.render(scene, camera);
                
                camera.updateMatrixWorld();

                var vector = camera.position.clone();

                var dis= Math.sqrt(Math.pow(vector.x,2)+Math.pow(vector.y,2));

                if (control.AutoRotation ==true){
                    rot +=1;
                    var speed =rot* 0.01 ;
                    camera.position.x = Math.cos(speed) * dis;
                    camera.position.y = Math.sin(speed) * dis;
                    camera.position.z = vector.z;
                    camera.lookAt(scene.position);
                }

                if(control.Trace < 2){
                    while (scene.children.length > 1) {
                        scene.remove(scene.children[scene.children.length - 1]);
                    }
                    pose(merged_file[current_file_num][parseInt(control.Time)],0.4);
                } else{
                    while (scene.children.length > 1) {
                        scene.remove(scene.children[scene.children.length - 1]);
                    }
                    for (var b=1; b<=control.Trace ;b=b+parseInt(control.Frameskip)){
                        poseseq(merged_file[current_file_num][parseInt(control.Time)+b],Math.pow(b/control.Trace,2)+0.05);
                    }
                }
                video.currentTime = parseInt(control.Time)/current_fps;
                // annotation_name.innerHTML = merged_file[current_file_num][parseInt(control.Time)][30+current_annot_num];
                annotation_name.innerHTML = control.Time;
            }

            var interval;
            var trace_color_code = [];
            for (var i = 0; i <= 10; i++){
                trace_color_code.push("rgb("+i*20+", "+i*20+", "+i*20+")");
            }

            // streaming();

            function streaming(){
                if(control.Playstatus == false) control.Time -= parseInt(control.Frameskip);
                
                clearInterval(interval);
                render();
                
                // tracePlot
                const tracePlot = document.getElementById('tracePlot');
                
                const svg = d3.select("#tracePlot");
                const xScale = d3.scaleLinear().domain([model_x_min[current_file_num], model_x_max[current_file_num]]).range([0, window.innerWidth/4]);
                const yScale = d3.scaleLinear().domain([model_y_min[current_file_num], model_y_max[current_file_num]]).range([window.innerWidth/4, 0]);
                
                svg.selectAll("circle").remove(); // Remove existing plot
                
                var data = plot_data[current_file_num].slice(parseInt(control.Time), parseInt(control.Time) + plot_number);
                svg
                    .selectAll("circle")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("cx", (d) => xScale(d.x))
                    .attr("cy", (d) => yScale(d.y))
                    .attr("r", 4)
                    // .style("fill", (d) => "black");
                    .style("fill", (d, i) => trace_color_code[(i+control.Time)%plot_number]);

                //streaming
                control.Time = parseInt(control.Time);
                control.Time += parseInt(control.Frameskip);
                if(control.Time>=skeleton_total_frame[current_file_num]) end_of_video();
                if(control.Time<0) control.Time = 0;
        
                interval = setInterval(streaming, 1000/control.Fps);
            }
           
            document.addEventListener("keydown", keyboard_down, false);
            function keyboard_down(event) {                
                if(event['key']==' '){
                    if(control.Playstatus==true) control.Playstatus = false;
                    else control.Playstatus = true;
                }
                if(event['key']=='ArrowRight'){
                    control.Time += parseInt(control.Frameskip);
                }
                if(event['key']=='ArrowLeft'){
                    control.Time -= parseInt(control.Frameskip);
                }
            }
            
            function set_annot_categories(n){
                var obj = document.getElementById("Annot_select");
                var temp = "";
                var newDiv = document.createElement("div");
                newDiv.setAttribute("id","New_annot");

                for(var i = 0; i < n; i++){
                    if(i==0){
                        temp = temp + "<input type='checkbox' id='chkbox_btn' name='chk_box' value='"+
                        annot_status2[current_file_num][current_annot_num][i]+"' checked=true> "+
                        annot_status2[current_file_num][current_annot_num][i]+"  ";
                    } else{
                        temp = temp + "<input type='checkbox' id='chkbox_btn' name='chk_box' value='"+
                        annot_status2[current_file_num][current_annot_num][i]+"'> "+
                        annot_status2[current_file_num][current_annot_num][i]+"  ";
                        annot_status[current_file_num][current_annot_num][annot_status2[current_file_num][current_annot_num][i]]=false;
                    }
                }
                obj.innerHTML = temp;
                for (var i = 0; i < n; i++){
                    // console.log(obj.children[i].checked);
                }
            }

            var chkbox = function(e){
                annot_status[current_file_num][current_annot_num][e.value] = e.checked;
                for(var i = 0; i < annot_status2[current_file_num][current_annot_num].length; i++){
                    if(annot_status[current_file_num][current_annot_num][annot_status2[current_file_num][current_annot_num][i]] == true) break;
                }
                if(i == annot_status2[current_file_num][current_annot_num].length){ 
                    annot_status[current_file_num][current_annot_num][String(e.value)] = true;
                    e.checked = true;
                }
            }

            const click_annot = function(e){
                const checkboxes = document.getElementsByName("chk_box");
                var temp = 0;
                checkboxes.forEach((cb) => {
                    if(e == "1"){
                        cb.checked = true;
                        annot_status[current_file_num][current_annot_num][cb.value] = true;
                    } else{
                        if(temp == 0){
                            cb.checked = true;
                            annot_status[current_file_num][current_annot_num][cb.value] = true;
                            temp = 1; 
                        } else{
                            cb.checked = false;
                            annot_status[current_file_num][current_annot_num][cb.value] = false;
                        }
                    }
                })
            }

            function videoinfo(file, n){
                const onChangeFile = (mediainfo) => {
                    const getSize = () => file.size;
                    const readChunk = (chunkSize, offset) =>
                        new Promise((resolve, reject) => {
                        const reader = new FileReader()
                            reader.onload = (event) => {
                                if (event.target.error) {
                                    reject(event.target.error)
                                }
                                resolve(new Uint8Array(event.target.result))
                            }
                            reader.readAsArrayBuffer(file.slice(offset, offset + chunkSize))
                        })

                        mediainfo
                        .analyzeData(getSize, readChunk)
                        .then((result) => {
                            video_fps[n] = result['media']['track'][1]['FrameRate'];
                        })
                        .catch((error) => {
                            output.value = `An error occured:\n${error.stack}`
                        })
                }
                MediaInfo(
                    {
                        // format: 'text',
                        format: 'object',
                        // locateFile: (path, prefix) => prefix + path, // Make sure WASM file is loaded from CDN location
                    },
                    (mediainfo) => { onChangeFile(mediainfo); }
                )
            }
        </script>
    </body>
</html>